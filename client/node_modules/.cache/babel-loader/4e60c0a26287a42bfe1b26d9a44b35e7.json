{"ast":null,"code":"import _slicedToArray from\"G:/Software/github/video-conference/client/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import React from\"react\";import Peer from'peerjs';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var peers=new Map();var my_stream_;var Streams=function Streams(_ref){var ws=_ref.ws;var video_grid=React.useRef();var _React$useState=React.useState(false),_React$useState2=_slicedToArray(_React$useState,2),play_toggled=_React$useState2[0],set_play_toggled=_React$useState2[1];var _React$useState3=React.useState(false),_React$useState4=_slicedToArray(_React$useState3,2),mute_toggled=_React$useState4[0],set_mute_toggled=_React$useState4[1];var toggle_play=function toggle_play(){var enabled=my_stream_.getVideoTracks()[0].enabled;if(enabled){my_stream_.getVideoTracks()[0].enabled=false;}else{my_stream_.getVideoTracks()[0].enabled=true;}set_play_toggled(!play_toggled);};var toggle_mute=function toggle_mute(){var enabled=my_stream_.getAudioTracks()[0].enabled;if(enabled){my_stream_.getAudioTracks()[0].enabled=false;}else{my_stream_.getAudioTracks()[0].enabled=true;}set_mute_toggled(!mute_toggled);};var add_video_stream=function add_video_stream(video,stream){video.srcObject=stream;video.addEventListener('loadedmetadata',function(){video.play();});video_grid.current.append(video);};var leave_meeting=function leave_meeting(){ws.ws.close();window.location.href='/';};React.useEffect(function(){navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(my_stream){my_stream_=my_stream;var my_video=document.createElement('video');my_video.muted=true;add_video_stream(my_video,my_stream);var my_peer;ws.on('uuid',function(json){// received my uuid\nmy_peer=new Peer(json.uuid);my_peer.on('call',function(call){console.log('Call from a peer');call.answer(my_stream);var remote_video=document.createElement('video');call.on('stream',function(remoteStream){add_video_stream(remote_video,remoteStream);});});my_peer.on('open',function(peerID){console.log('You joined room as '+peerID);ws.send(JSON.stringify({target:\"new_peer\",peerID:peerID}));});});ws.on('new_peer',function(json){// New peer received\nconsole.log('you called a new peer');var call=my_peer.call(json.peerID,my_stream);var remote_video=document.createElement('video');call.on(\"stream\",function(remoteStream){// answer of the call\nadd_video_stream(remote_video,remoteStream);});call.on('close',function(){remote_video.remove();});peers.set(json.peerID,call);});ws.send(JSON.stringify({target:'uuid'}));}).catch(function(err){console.error(\"Failed to get local stream\",err);});ws.on('peer_disconnected',function(json){console.log('peer left');peers.get(json.peerID).close();peers.delete(json.peerID);});},[ws]);// React.useEffect(()=>{\n//     set_render(!render)\n// },[video_grid, render])\nreturn/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"video_grid\",ref:video_grid}),/*#__PURE__*/_jsxs(\"div\",{className:\"controller\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stream_control_block\",children:[play_toggled?/*#__PURE__*/_jsxs(\"div\",{onClick:toggle_play,className:\"play stream_control_button\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"/icons/video.webp\",alt:\"\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Play Video\"})]}):/*#__PURE__*/_jsxs(\"div\",{onClick:toggle_play,className:\"stream_control_button\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"/icons/video.webp\",alt:\"\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Stop Video\"})]}),mute_toggled?/*#__PURE__*/_jsxs(\"div\",{onClick:toggle_mute,className:\"unmute stream_control_button\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"/icons/mic.webp\",alt:\"\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Unmute\"})]}):/*#__PURE__*/_jsxs(\"div\",{onClick:toggle_mute,className:\"stream_control_button\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"/icons/mic.webp\",alt:\"\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Mute\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stream_control_block\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stream_control_button\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"/icons/participants.webp\",alt:\"\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Participants\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stream_control_button\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"/icons/chat.webp\",alt:\"\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Chat\"})]})]}),/*#__PURE__*/_jsx(\"div\",{onClick:leave_meeting,className:\"leave_meetig stream_control_button\",children:/*#__PURE__*/_jsx(\"span\",{children:\"Leave Meeting\"})})]})]});};export default Streams;","map":{"version":3,"names":["React","Peer","peers","Map","my_stream_","Streams","ws","video_grid","useRef","useState","play_toggled","set_play_toggled","mute_toggled","set_mute_toggled","toggle_play","enabled","getVideoTracks","toggle_mute","getAudioTracks","add_video_stream","video","stream","srcObject","addEventListener","play","current","append","leave_meeting","close","window","location","href","useEffect","navigator","mediaDevices","getUserMedia","audio","then","my_stream","my_video","document","createElement","muted","my_peer","on","json","uuid","call","console","log","answer","remote_video","remoteStream","peerID","send","JSON","stringify","target","remove","set","catch","err","error","get","delete"],"sources":["G:/Software/github/video-conference/client/src/components/Streams.tsx"],"sourcesContent":["import React from \"react\";\r\nimport My_websocket from '../my_websocket'\r\nimport Peer from 'peerjs'\r\n\r\nlet peers=new Map()\r\nlet my_stream_: MediaStream\r\ninterface ws_{\r\n    ws: My_websocket\r\n  }\r\nconst Streams=({ws}: ws_)=>{\r\n    const video_grid=React.useRef<any>()\r\n    const [play_toggled, set_play_toggled]=React.useState(false)\r\n    const [mute_toggled, set_mute_toggled]=React.useState(false)\r\n\r\n    const toggle_play = () => {\r\n        let enabled = my_stream_.getVideoTracks()[0].enabled;\r\n        if (enabled) {\r\n            my_stream_.getVideoTracks()[0].enabled = false;\r\n        } else {\r\n          my_stream_.getVideoTracks()[0].enabled = true;\r\n        }\r\n        set_play_toggled(!play_toggled)\r\n      }\r\n\r\n    const toggle_mute = () => {\r\n        const enabled = my_stream_.getAudioTracks()[0].enabled;\r\n        if (enabled) {\r\n            my_stream_.getAudioTracks()[0].enabled = false;\r\n        } else {\r\n          my_stream_.getAudioTracks()[0].enabled = true;\r\n        }\r\n        set_mute_toggled(!mute_toggled)\r\n      }\r\n\r\n      const add_video_stream=(video: HTMLVideoElement, stream: MediaStream)=>{\r\n        video.srcObject = stream\r\n        video.addEventListener('loadedmetadata', () => {\r\n            video.play()\r\n        })\r\n        video_grid.current.append(video)\r\n    }\r\n\r\n    const leave_meeting=()=>{\r\n        ws.ws.close()\r\n        window.location.href='/'\r\n    }\r\n\r\n    React.useEffect(()=>{\r\n        navigator.mediaDevices.getUserMedia({ video: true, audio: true })\r\n        .then(my_stream => {\r\n            my_stream_=my_stream\r\n            const my_video = document.createElement('video')\r\n            my_video.muted=true\r\n            add_video_stream(my_video, my_stream)\r\n\r\n            let my_peer: Peer\r\n            ws.on('uuid', (json: any)=>{ // received my uuid\r\n                my_peer=new Peer(json.uuid)\r\n                my_peer.on('call', (call: any) => {\r\n                    console.log('Call from a peer')\r\n                    call.answer(my_stream)\r\n                    const remote_video = document.createElement('video')\r\n                    call.on('stream', (remoteStream: MediaStream) => {\r\n                        add_video_stream(remote_video, remoteStream)\r\n                    })\r\n                })\r\n                my_peer.on('open', peerID => {\r\n                    console.log('You joined room as '+peerID)\r\n                    ws.send(JSON.stringify({target: \"new_peer\", peerID: peerID}))\r\n                })\r\n            })\r\n            ws.on('new_peer', (json: any)=>{ // New peer received\r\n                console.log('you called a new peer')\r\n                const call = my_peer.call(json.peerID, my_stream);\r\n                const remote_video = document.createElement('video')\r\n                call.on(\"stream\", (remoteStream) => { // answer of the call\r\n                    add_video_stream(remote_video, remoteStream)\r\n                });\r\n                call.on('close', () => {\r\n                    remote_video.remove()\r\n                })\r\n                peers.set(json.peerID, call)\r\n            })\r\n            ws.send(JSON.stringify({target: 'uuid'}))\r\n        })\r\n        .catch(err => {\r\n            console.error(\"Failed to get local stream\", err);\r\n        })\r\n        \r\n        ws.on('peer_disconnected', (json: any)=>{\r\n            console.log('peer left')\r\n            peers.get(json.peerID).close()\r\n            peers.delete(json.peerID)\r\n        })\r\n    },[ws])\r\n\r\n    // React.useEffect(()=>{\r\n    //     set_render(!render)\r\n    // },[video_grid, render])\r\n\r\n    return(\r\n        <>\r\n        <div className=\"video_grid\" ref={video_grid}></div>\r\n        <div className=\"controller\">\r\n            <div className=\"stream_control_block\">\r\n                {play_toggled?\r\n                <div onClick={toggle_play} className=\"play stream_control_button\" >\r\n                    <img src='/icons/video.webp' alt=\"\"/>\r\n                    <span>Play Video</span>\r\n                </div>\r\n                :\r\n                <div onClick={toggle_play} className=\"stream_control_button\" >\r\n                    <img src='/icons/video.webp' alt=\"\"/>\r\n                    <span>Stop Video</span>\r\n                </div>}\r\n                {mute_toggled?\r\n                <div onClick={toggle_mute} className=\"unmute stream_control_button\" >\r\n                    <img src='/icons/mic.webp' alt=\"\"/>\r\n                    <span>Unmute</span>\r\n                </div>\r\n                :\r\n                <div onClick={toggle_mute} className=\"stream_control_button\" >\r\n                    <img src='/icons/mic.webp' alt=\"\"/>\r\n                    <span>Mute</span>\r\n                </div>}\r\n            </div>\r\n            <div className=\"stream_control_block\">\r\n                <div className=\"stream_control_button\">\r\n                    <img src='/icons/participants.webp' alt=\"\"/>\r\n                    <span>Participants</span>\r\n                </div>\r\n                <div className=\"stream_control_button\">\r\n                    <img src='/icons/chat.webp' alt=\"\"/>\r\n                    <span>Chat</span>\r\n                </div>\r\n            </div>\r\n            <div onClick={leave_meeting} className=\"leave_meetig stream_control_button\">\r\n                <span>Leave Meeting</span>\r\n            </div>\r\n        </div>\r\n        </>\r\n    )\r\n}\r\nexport default Streams"],"mappings":"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"},"metadata":{},"sourceType":"module"}